---
title: "Group 7 - Classification model for the default status"
author: "L. Becker, A. Chebatarova, A. Kandel, A.Kusche, R. Mizrak"
date: 'Sys.Date()'
output:
  pdf_document: default
  html_document:
    df_print: paged
---

## Initialization

```{r initialization, results="hide"}
source(file = "functions.R")
func_init_env()
```

```{r loading Rds file, results="hide"}
dataset <- func_data_load()
```

```{r preprocessing, echo=TRUE}
dataset <- func_data_prep(dataset)
```

## Preprocessing

```{r concluded loans results= FALSE}
# Make a data.table
setDT(dataset)

# filter out all observations with loan_status == Current
dataset <- dataset[loan_status != 'Current']

# Change all the loan status that are not "Fully Paid" to "Default"
dataset$loan_status[dataset$loan_status != "Fully Paid"] <- "Default"

# Remove unused factor levels
dataset$loan_status <- factor(dataset$loan_status)

# Removing Feature 
dataset <- subset(dataset, select = -c(hardship_type, hardship_reason, hardship_status, hardship_loan_status,settlement_status, verification_status_joint, hardship_flag, disbursement_method, debt_settlement_flag, application_type, purpose, pymnt_plan, verification_status, home_ownership, initial_list_status, term))
```

## Create Train and Testset

```{r validation set approach}
# setting a seed for reproducability
set.seed(7)

# random split into  train and test set, with a ratio of 20:80
trainIndex <- sample(1:nrow(dataset),0.8*nrow(dataset))

train.data <- dataset[trainIndex,]
test.data  <- dataset[-trainIndex,]

# creating a small subset of data for testing models
train_smallIndex  <- sample(1:nrow(train.data), 1000)
test_smallIndex   <- sample(1:nrow(test.data), 1000)

small_train <- dataset[train_smallIndex,]
small_test  <- dataset[test_smallIndex,]
```

# https://www.r-bloggers.com/partial-least-squares-in-r/
```{r}
# Compile cross-validation settings
set.seed(100)
myfolds <- createMultiFolds(train.data, k = 5, times = 10)
control <- trainControl("repeatedcv", index = myfolds, selectionFunction = "oneSE")
 
```

#Perform Partial Least Squares Regression
```{r}

# Train PLS model
mod1 <- train(loan_status ~ ., data = train.data,
 method = "pls",
 metric = "Accuracy",
 tuneLength = 20,
 trControl = control,
 preProc = c("zv","center","scale"))

```

#Perform Principal Component Analysis 
```{r}
# PCA-DA
mod2 <- train(loan_status ~ ., data = train.data,
method = "lda",
metric = "Accuracy",
trControl = control,
preProc = c("zv","center","scale","pca"))
 
plot(mod1)

```

# Compile models and compare performance
```{r, message=FALSE, warning=FALSE, results="hide"}

models <- resamples(list("PLS-DA" = mod1, "PCA-DA" = mod2))
bwplot(models, metric = "Accuracy")

plot(varImp(mod1), 10, main = "PLS-DA")
plot(varImp(mod2), 10, main = "PCA-DA")


```
Perform the classification using Decision tree.
```{r }

```
Perform the classification using Logistic Regression.
```{r }

```
Perform the classification using KNN.
```{r k-NN}
# Set random seed.
set.seed(7)

# Creating test and train labels
train_labels <- small_train$defaulted
test_labels <- small_test$defaulted

# 
knn_train <- small_train
knn_test <- small_test

# droping defaulted columns
knn_train$defaulted <- NULL
knn_test$defaulted <- NULL

# Make predictions using knn: pred
pred <- knn(train = knn_train, test = knn_test, cl = train_labels, k = 5)

# Construct the confusion matrix: conf
conf <- table(test_labels, pred)

# Print out the confusion matrix
conf

# Define range and accs
range <- 1:round(0.2 * nrow(knn_train))
accs <- rep(0, length(range))
for (k in range) {

  # Make predictions using knn: pred
  pred <- knn(knn_train, knn_test, train_labels, k = k)

  # Construct the confusion matrix: conf
  conf <- table(test_labels, pred)

  # Clculate the accuracy and store it in accs[k]
  accs[k] <- sum(diag(conf)) / sum(conf)
}
# Plot the accuracies.
plot(range, accs, xlab = "k")

# Calculate the best k
which.max(accs)
```
Perform the classification using Random forest.
```{r }

```
Compare the respective train and test error performances to select one of these approaches.
```{r }

```

Perform the prediction on the validation set and compute the confusion matrix.
```{r }

```

Conceptually compare your approach with a solution existing for this problem. (Default
prediction is a very well-known problem in literature).
```{r }

```
