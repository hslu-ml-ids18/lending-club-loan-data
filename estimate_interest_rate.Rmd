---
title: "Group X - Estimate interest rate"
author: "L. Becker, A. Chebatarova, A. Kandel, A.Kusche, R. Mizrak"
date: 'Sys.Date()'
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Initialization

```{r initialization, message=FALSE, warning=FALSE, results="hide"}
rm(list=(ls()))

# Loading required packages

# library(Metrics)
library(corrplot)
library(randomForest)
library(rmarkdown)
library(foreach)
library(plyr)
# library(doMC)
library(tidyverse)
library(magrittr)
library(data.table)
library(dplyr)
# registerDoMC(4)

# library(doParallel)  
# registerDoParallel()
```

<!-- ```{r Data Loading} -->
<!-- # we load the loan file and select lineitems that fit our group number 7 -->
<!-- # we might move this somewhere else and use only the prepared csv as this is time consuming -->

<!-- loan_df <- read.csv(file = "loan.csv", header = TRUE) -->
<!-- loan_df <- cbind(id_2 = rownames(loan_df), loan_df) -->
<!-- rownames(loan_df) <- 1:nrow(loan_df) -->
<!-- loan_df$id_2 <- as.numeric(loan_df$id_2) -->
<!-- dataset_7 <- loan_df[which(loan_df$id_2%%8+1== 7),] -->
<!-- ``` -->

<!-- ```{r Saving dataset as rds} -->

<!-- # Write RDS in R -->

<!-- # saveRDS(dataset_7, file = "dataset_7.Rds") -->
<!-- ``` -->

```{r loading Rds file}
dataset_7 <- read_rds("dataset_7.Rds")
```

```{r Data Preparation NAs removal}
# Given we want to do a regression analysis we want to change boolean string values to numeric ones.
# Omiting columns that only have NAs, ie. id and member_id.
dataset <- dataset_7[,colSums(is.na(dataset_7))<nrow(dataset_7)]

# changing the dataset as a tbl object.
dataset <- as.tbl(dataset)
# change NAs to 0 in integer columns
dataset <- mutate_if(dataset, is.integer, ~replace(., is.na(.), 0))
# change NAs to 0 in doubles columns

dataset <- mutate_if(dataset, is.numeric, ~replace(., is.na(.), 0))
# change NAs to 0 in strings columns

dataset <- mutate_if(dataset, is.character, ~replace(., is.na(.), 0))

# calculating the number of unique levels per column
sapply(dataset, function(col) length(unique(col)))

#removing dataset_7
rm(dataset_7)

# changing emp_title from integer to string
emp_title <- toString(emp_title)

# changing emp_title "" values to "unknown"
emp_title[emp_title == ""] <- "Unknown"

# attaching the cleaned dataset
attach(dataset)

```

```{r validation set approach}
# setting a seed for reproducability
set.seed(7)
# We randomly split our dataframe in a train and test set
trainRows = sample(1:nrow(dataset),0.5*nrow(dataset))
testRows = nrow(dataset) - trainRows

```

<!-- ```{r} -->
<!-- # we can probably remove the 2 below lines -->
<!-- lm_func <- function(y) lm(int_rate ~., data = dataset) -->
<!-- lapply(dataset, lm_func) -->
<!-- ``` -->


```{r Data Exploration - lm}
# idealy we would do an lm on the whole dataset like this:
# lmp.fit=lm(int_rate~.,data = dataset)
# but we run into not enough levels error.
# the below lm works, by manualy removing the colums that R see as only having 1 level
# this means we still need to do some data cleaning with these factors.
# -total_rec_late_fee, has multiple level but are basically all around 0

lmp.fit=lm(int_rate~., data=subset(dataset, select=c(-emp_title, -hardship_type, -issue_d, -desc, -title, -zip_code, -earliest_cr_line, -total_rec_late_fee, -last_pymnt_d, -next_pymnt_d, -last_credit_pull_d, -policy_code, -sec_app_earliest_cr_line, -deferral_term, -hardship_length, -debt_settlement_flag_date, -settlement_date)), na.action = na.exclude)
# if we want to use lm(int_rate~.,data=dataset_7)
# We need to modify our dataframe to avoid this error.
# Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
#   contrasts can be applied only to factors with 2 or more levels

summary(lmp.fit)
```

```{r Data Exploration - interest rate vs loan amount}
# plotting the loan amount vs the interest rate
plot(loan_amnt ,int_rate)
# from this visualisation we can't see any clear correlation.

plot(int_rate, loan_amnt)

```

```{r Data Exploration - interest rate vs term}
# plotting the loan amount vs the term

plot(term, int_rate)
# Here we can see that the interest rate is generaly higher for 60 months loans and lower for 36 months loans.
```

```{r Data Exploration - interest rate vs grade}
# plotting the loan amount vs the grade

plot(grade, int_rate)
# The Grade seems to have a strong influence on the interest rate
plot(sub_grade, int_rate)
# We see the same but with a greater granualrity. 

```

```{r Data Exploration - interest rate vs home ownership}
# plotting the loan amount vs home ownership

plot(home_ownership, int_rate)
# Here we can see that the interest rate is generaly higher for 60 months loans and lower for 36 months loans.
```

```{r Data Exploration - interest rate vs verification_status}
# plotting the loan amount vs verification_status

plot(verification_status, int_rate)
# The verification_status seems to also have an influence on the interest rate.

```

```{r Data Exploration - interest rate vs emp_title}
# plotting the loan amount vs verification_status

plot(emp_title, int_rate)
# The verification_status seems to also have an influence on the interest rate.

```