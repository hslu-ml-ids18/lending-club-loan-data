---
title: "Group X - Estimate interest rate"
author: "L. Becker, A. Chebatarova, A. Kandel, A.Kusche, R. Mizrak"
date: 'Sys.Date()'
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Initialization

```{r initialization, message=FALSE, warning=FALSE, results="hide"}
rm(list=(ls()))

# Loading required packages with library pacman
pacman::p_load(corrplot, randomForest, rmarkdown, foreach, plyr, tidyverse, magrittr, data.table, dplyr, tibble)
```


```{r validation set approach}
# setting a seed for reproducability
set.seed(7)
# We randomly split our dataframe in a train and test set
trainRows = sample(1:nrow(dataset),0.5*nrow(dataset))
testRows = nrow(dataset) - trainRows

```

<!-- ```{r} -->
<!-- # we can probably remove the 2 below lines -->
<!-- lm_func <- function(y) lm(int_rate ~., data = dataset) -->
<!-- lapply(dataset, lm_func) -->
<!-- ``` -->


```{r Data Exploration - lm}
# idealy we would do an lm on the whole dataset like this:
# lmp.fit=lm(int_rate~.,data = dataset)
# but we run into not enough levels error.
# the below lm works, by manualy removing the colums that R see as only having 1 level
# this means we still need to do some data cleaning with these factors.
# -total_rec_late_fee, has multiple level but are basically all around 0

lmp.fit=lm(int_rate~., data=subset(dataset, select=c(-emp_title, -hardship_type, -issue_d, -desc, -title, -zip_code, -earliest_cr_line, -total_rec_late_fee, -last_pymnt_d, -next_pymnt_d, -last_credit_pull_d, -policy_code, -sec_app_earliest_cr_line, -deferral_term, -hardship_length, -debt_settlement_flag_date, -settlement_date)), na.action = na.exclude)
# if we want to use lm(int_rate~.,data=dataset_7)
# We need to modify our dataframe to avoid this error.
# Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
#   contrasts can be applied only to factors with 2 or more levels

summary(lmp.fit)
```

```{r stepwise model}
# should we use a gaussian model here?
null_model <- glm(int_rate ~ 1, data = dataset, family = "gaussian")

# Specify the partial model using a subset of the potential predictors
partial_model <- glm(int_rate ~ ., data=subset(dataset, select=c(-emp_title, -hardship_type, -issue_d, -desc, -title, -zip_code, -earliest_cr_line, -total_rec_late_fee, -last_pymnt_d, -next_pymnt_d, -last_credit_pull_d, -policy_code, -sec_app_earliest_cr_line, -deferral_term, -hardship_length, -debt_settlement_flag_date, -settlement_date)), family = "gaussian")
# 
# # This is taking too much time to process, stoped this at the 12th perdictor.
# # Use a forward stepwise algorithm to build a parsimonious model
# step_model <- step(null_model, scope = list(lower = null_model, upper = partial_model), direction = "forward")
# #  int_rate ~ sub_grade + all_util + loan_status + total_pymnt + installment + initial_list_status + total_pymnt_inv + verification_status + loan_amnt + term + out_prncp_inv + inq_fi
# 

# Estimate the stepwise probability
step_prob <- predict(step_model, type = "response")

# Plot the ROC of the stepwise model
library(pROC)
ROC <- roc(dataset$int_rate, step_prob)
plot(ROC, col = "red")
auc(ROC)
```

```{r Random Forest}

int_rate_RF <- randomForest(int_rate ~. , data=subset(dataset, select=c(-emp_title, -hardship_type, -issue_d, -desc, -title, -zip_code, -earliest_cr_line, -total_rec_late_fee, -last_pymnt_d, -next_pymnt_d, -last_credit_pull_d, -policy_code, -sec_app_earliest_cr_line, -deferral_term, -hardship_length, -debt_settlement_flag_date, -settlement_date)) , subset =  trainRows, importance=TRUE, do.trace = TRUE)

```

```{r Data Exploration - interest rate vs loan amount}
# plotting the loan amount vs the interest rate
plot(loan_amnt ,int_rate)
# from this visualisation we can't see any clear correlation.

plot(int_rate, loan_amnt)

```

```{r Data Exploration - interest rate vs term}
# plotting the loan amount vs the term

plot(term, int_rate)
# Here we can see that the interest rate is generaly higher for 60 months loans and lower for 36 months loans.
```

```{r Data Exploration - interest rate vs grade}
# plotting the loan amount vs the grade

plot(grade, int_rate)
# The Grade seems to have a strong influence on the interest rate
plot(sub_grade, int_rate)
# We see the same but with a greater granualrity. 

```

```{r Data Exploration - interest rate vs home ownership}
# plotting the loan amount vs home ownership

plot(home_ownership, int_rate)
# Here we can see that the interest rate is generaly higher for 60 months loans and lower for 36 months loans.
```

```{r Data Exploration - interest rate vs verification_status}
# plotting the loan amount vs verification_status

plot(verification_status, int_rate)
# The verification_status seems to also have an influence on the interest rate.

```

```{r Data Exploration - interest rate vs emp_title}
# plotting the loan amount vs verification_status

plot(emp_title, int_rate)
# The verification_status seems to also have an influence on the interest rate.

```